# CV流水线框架设计文档

## 背景和目标

### 背景

在对一张图像进行推理时，我们会遇到图像较大（比如图像是遥感影响，大小是60000*60000像素大小），此时需要一个流水线并发的框架，能够对图像进行并发的推理，提升推理的效率。

具体而言，一个图像的推理过程包含：数据读取 -》图像切片 -》切片并行推理 -》推理结果合并 4个步骤，通过该框架可以实现并发的读取、切片、推理。

### 目标
实现一个高效的cv流水线并发推理框架，具备如下能力

- 提供高效的并发处理能力
- 支持灵活的任务编排
- 实现可靠的错误处理机制
- 提供进度监控功能

## 需求分析

### 功能需求

- 支持数据并行处理
- 提供任务状态监控
- 支持处理进度和过程指标追踪

### 性能需求

- 支持可配置的并行度设置
- 最小化数据传输开销
- 实现数据的并行处理
- 内存使用效率最优

### 可扩展需求
- 支持数据处理算在动态添加或者用户自定义扩展
- 支持从对象存储或文件存储读取图像数据
- 支持对读取的图像数据进行切分，并做并行处理

### 可靠性需求
- 实现背压机制，避免内存溢出

## 系统架构设计

系统采用iterator进行流水线处理，应包含如下组件

- PipelineOperator: 流水线算子基类
- MapLikeOperator: 转换类的算子实现类
- SourceOperator： 图像数据读取算子实现
- EventListener: 事件监听机制
- PipelineEvent: 有各类事件，比如算子开始事件、算子完成事件

## 使用示例

### 图像并行推理的使用示例

- 需要实现一个example的例子，实现从文件存储读取一个大图像进行并发处理


